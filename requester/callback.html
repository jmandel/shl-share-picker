<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Callback</title>
</head>

<body>
  <script>
    // 1. Parse the Hash
    const params = new URLSearchParams(window.location.hash.substring(1));
    const vpToken = params.get('vp_token');
    const smartArtifacts = params.get('smart_artifacts');
    const state = params.get('state');

    if (vpToken && smartArtifacts && state) {
      // 2. Send data to main window via BroadcastChannel
      const channel = new BroadcastChannel('shl-' + state);

      console.log('[Callback] Sending OID4VP response:', { state, vpTokenLength: vpToken.length, artifactsLength: smartArtifacts.length });
      channel.postMessage({
        state: state,
        vp_token: JSON.parse(vpToken),
        smart_artifacts: JSON.parse(smartArtifacts)
      });

      // 3. Close this popup/tab
      setTimeout(() => {
        console.log('[Callback] Closing window');
        window.close();
      }, 500);
    } else {
      console.error('[Callback] Missing parameters:', { vpToken: !!vpToken, smartArtifacts: !!smartArtifacts, state: !!state });
      document.body.textContent = "Error: Missing parameters.";
    }
  </script>
</body>

</html>